<svelte:head>
  <title>Ross Hill - Website and Portfolio</title>
</svelte:head>
<Header/>
<PostControls bind:sort bind:searchString/>
<Posts posts={visiblePosts}/>
<script>
  export default {
    components: {
      Header: "../components/Header.html",
      Posts: "../components/Posts.html",
      PostControls: "../components/PostControls.html"
    },
    data() {
			return {
        sort: "new",
        searchString: "",
        posts: [],
        visiblePosts: []
			};
    },
    methods: {
      filterPosts: (posts, searchString) => {
        if (searchString) {
          posts = posts.filter(
            post =>
              post.title.toLowerCase().includes(searchString) ||
              post.content.toLowerCase().includes(searchString)
          );
        }
        return posts;
      },

      shuffle: arr => {
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
      },

      compare: (a, b, sort) => {
        switch (sort) {
          case "alpha": {
            if (a.title < b.title) return -1;
            if (a.title > b.title) return 1;
            else return 0;
          }
          case "revalpha": {
            if (a.title > b.title) return -1;
            if (a.title < b.title) return 1;
            else return 0;
          }
          case "old": {
            return new Date(a.date) - new Date(b.date);
          }
          default: {
            // new
            return new Date(b.date) - new Date(a.date);
          }
        }
      }
    },

    onstate({ changed, current, previous }) {
			if (changed.sort || changed.searchString) {
        const searchString = current.searchString.toLowerCase();
        const sort = current.sort.toLowerCase();
        const filtered = this.filterPosts(current.posts, searchString);

        let visiblePosts;

        if (sort.toLowerCase() === "shuffle") visiblePosts = this.shuffle(filtered);
        else visiblePosts = filtered.sort((a, b) => this.compare(a, b, sort));

        this.set({visiblePosts});
			}
    },
    
    preload(data) {
      return this.fetch(`index.json`)
        .then(r => r.json())
        .then(posts => {
          return { posts, visiblePosts: posts };
        });
    }
  };
</script>
